<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shared Christmas Tree ‚Äî decorate together</title>

<style>
  :root{
    --blue: #84D4F6;
    --offwhite: #F6F5F3;
    --accent: #FFD700;
    --muted: #9aa8b0;
  }

  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{

  /* right: controls */
  .controls {
    width:300px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .palette {
    background:var(--offwhite);
    padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);
  }
  .palette h3{margin:0 0 8px 0;font-size:14px;color:var(--blue)}
  .ornament-row {display:flex;gap:8px;flex-wrap:wrap}
  .orn-btn{
    width:46px;height:46px;border-radius:50%;display:inline-grid;place-items:center;
    cursor:pointer;border:2px solid rgba(0,0,0,0.06);box-shadow:0 4px 8px rgba(0,0,0,0.04);
    transition:transform .12s;
  }
  .orn-btn:active{transform:scale(.96)}

  /* action buttons */
  .actions {display:flex;gap:8px;flex-wrap:wrap}
  button {padding:8px 10px;border-radius:8px;border:0;background:var(--blue);color:#013;cursor:pointer;font-weight:600}
  .ghost {background:transparent;border:1px solid rgba(0,0,0,0.08);color:#333}
  .wide {width:100%}

  /* tree container */
  .tree-stage { width:560px; height:640px; position:relative; user-select:none; touch-action:none; }
  /* svg fills remaining area */
  .tree-svg { width:100%; height:100%; display:block; }

  /* ornament elements placed as absolutely positioned DOM nodes */
  .ornament {
    position:absolute; width:36px;height:36px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;color:#111;font-size:12px;
    box-shadow:0 6px 10px rgba(0,0,0,0.12);
    transform:translate(-50%,-50%);
    cursor:grab;
    touch-action:none;
  }
  .ornament:active{cursor:grabbing}

  footer {margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
  .small {font-size:12px;color:var(--muted)}
  pre{font-size:11px;white-space:pre-wrap;background:#fff;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.04)}
</style>
</head>
<body>
  <div class="page" role="application">
    <header>
      <div>
        <h1>Shared Christmas Tree</h1>
        <div class="subtitle">Decorate together ‚Äî save locally or export/import. (Cloud sync instructions below.)
        <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Christmas Tree Decorator</title>
  <link rel="stylesheet" href="style.css">
  <script defer src="script.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>

<body>

  <header>
    <h1>Decorate the Tree Together</h1>
  </header>

  <main>

    <div id="tree-container">
      <img id="tree" src="tree.png" alt="Christmas Tree">
    </div>

    <div id="ornament-tray">
      <img class="ornament" draggable="true" src="ornaments/star.png" data-type="star">
      <img class="ornament" draggable="true" src="ornaments/bauble-red.png" data-type="red">
      <img class="ornament" draggable="true" src="ornaments/bauble-blue.png" data-type="blue">
      <img class="ornament" draggable="true" src="ornaments/candy.png" data-type="candy">
      <img class="ornament" draggable="true" src="ornaments/bell.png" data-type="bell">
    </div>
      <div class="small">Colors: <span style="color:var(--blue)">#84D4F6</span> &nbsp; <span style="color:var(--offwhite)">#F6F5F3</span></div>

    
    <div class="layout">
      <div class="canvas-wrap">
        <div class="tree-stage" id="stage">
          <!-- SVG tree (pure decorative) -->
          <svg class="tree-svg" viewBox="0 0 400 460" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
            <!-- trunk -->
            <rect x="182" y="380" width="36" height="60" rx="6" fill="#7b4f2b"></rect>
            <!-- layered tree shapes -->
            <path d="M200 60 L110 200 L290 200 Z" fill="#0f7b3a"></path>
            <path d="M200 130 L90 280 L310 280 Z" fill="#0b6e33"></path>
            <path d="M200 210 L70 360 L330 360 Z" fill="#075f2a"></path>
            <!-- star -->
            <polygon points="200,30 210,48 230,50 214,63 220,82 200,72 180,82 186,63 170,50 190,48"
              fill="gold"></polygon>
          </svg>
        </div>
      </div>

      <aside class="controls">
        <div class="palette">
          <h3>Add ornament</h3>
          <div class="ornament-row" id="palette">
            <!-- buttons injected by JS -->
          </div>
        </div>

        <div class="palette">
          <h3>Tools</h3>
          <div class="actions">
            <button id="saveLocal">Save (local)</button>
            <button id="loadLocal" class="ghost">Load (local)</button>
            <button id="clear" class="ghost">Clear</button>
            <button id="export" class="ghost">Export JSON</button>
            <button id="import" class="ghost">Import JSON</button>
          </div>
          <input id="importFile" type="file" accept="application/json" style="display:none">
        </div>

        <div class="palette">
          <h3>Cloud (optional)</h3>
          <div class="small">If you want automatic sync via iCloud, set up a CloudKit container and paste configuration into the script area. See comments inside the file for details.</div>
          <div style="margin-top:8px" class="actions">
            <button id="saveCloud" class="ghost">Save ‚Üí iCloud</button>
            <button id="loadCloud" class="ghost">Load ‚Üê iCloud</button>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      <div class="small">Tip: drag ornaments to move them. Export and share JSON file if you want to send the layout directly to a friend.</div>
    </footer>
  </div>

<!-- Modal placeholder not needed (we place ornaments as DOM nodes) -->

<script>
/* -------------------------
   Data model: list of ornaments
   each ornament: { id, type, x, y, color }
   x,y are percent of stage width/height (0-100)
   ------------------------- */

const stage = document.getElementById('stage');
const paletteEl = document.getElementById('palette');
const saveLocalBtn = document.getElementById('saveLocal');
const loadLocalBtn = document.getElementById('loadLocal');
const clearBtn = document.getElementById('clear');
const exportBtn = document.getElementById('export');
const importBtn = document.getElementById('import');
const importFile = document.getElementById('importFile');
const saveCloudBtn = document.getElementById('saveCloud');
const loadCloudBtn = document.getElementById('loadCloud');

const STAGE_KEY = 'sharedTree_v1';

// palette definitions
const PALETTE = [
  {type:'ball-red', color:'#E84545', label:'Red'},
  {type:'ball-blue', color:'#3D9AD7', label:'Blue'},
  {type:'ball-gold', color:'#FFD700', label:'Gold'},
  {type:'bow', color:'#FF8FB1', label:'Bow'},
  {type:'bell', color:'#C28500', label:'Bell'},
  {type:'gift', color:'#84D4F6', label:'Gift'}
];

let ornaments = []; // current ornament models

// util id
function uid(prefix='o'){ return prefix + Math.random().toString(36).slice(2,9); }

// create palette buttons
PALETTE.forEach(p=>{
  const btn = document.createElement('button');
  btn.className = 'orn-btn';
  btn.title = p.label;
  btn.style.background = p.color;
  btn.addEventListener('click', ()=>addOrnament(p));
  btn.innerHTML = ''; // empty circle (color shows)
  paletteEl.appendChild(btn);
});

// Add ornament at center by default
function addOrnament(def){
  const rect = stage.getBoundingClientRect();
  const model = {
    id: uid(),
    type: def.type,
    color: def.color,
    x: 50, y: 45, // percent
  };
  ornaments.push(model);
  renderOrnaments();
  saveLocalDebounced();
}

// render all ornaments DOM
function renderOrnaments(){
  // clear current nodes
  // keep order stable
  const existing = stage.querySelectorAll('.ornament');
  existing.forEach(n=>n.remove());

  ornaments.forEach(o=>{
    const el = document.createElement('div');
    el.className = 'ornament';
    el.dataset.id = o.id;
    el.style.left = o.x + '%';
    el.style.top = o.y + '%';
    el.style.background = o.color;
    el.title = o.type;
    // inner label icon
    el.textContent = o.type.startsWith('ball') ? '' : (o.type === 'bow' ? 'üéÄ' : (o.type === 'bell' ? 'üîî' : (o.type === 'gift' ? 'üéÅ' : '')));
    // make draggable via pointer events
    attachDrag(el, o);
    stage.appendChild(el);
  });
}

function attachDrag(el, model){
  let pointerId = null;
  function getPos(e){
    // use clientX/ clientY for pointer events and touch events (pointer normalized)
    const rect = stage.getBoundingClientRect();
    const clientX = (e.clientX !== undefined) ? e.clientX : (e.touches && e.touches[0] && e.touches[0].clientX);
    const clientY = (e.clientY !== undefined) ? e.clientY : (e.touches && e.touches[0] && e.touches[0].clientY);
    let x = ((clientX - rect.left) / rect.width) * 100;
    let y = ((clientY - rect.top) / rect.height) * 100;
    // clamp
    x = Math.max(2, Math.min(98, x));
    y = Math.max(2, Math.min(98, y));
    return {x,y};
  }

  function start(e){
    e.preventDefault();
    el.setPointerCapture?.(e.pointerId);
    pointerId = e.pointerId;
    el.classList.add('dragging');
  }
  function move(e){
    if (pointerId !== null && (e.pointerId === undefined || e.pointerId === pointerId || e.touches)) {
      const p = getPos(e);
      model.x = p.x; model.y = p.y;
      el.style.left = model.x + '%'; el.style.top = model.y + '%';
    }
  }
  function end(e){
    if (pointerId !== null) {
      try{ el.releasePointerCapture?.(pointerId); }catch(e){}
      pointerId = null;
      el.classList.remove('dragging');
      saveLocalDebounced();
    }
  }

  // pointer events
  el.addEventListener('pointerdown', start);
  window.addEventListener('pointermove', move);
  window.addEventListener('pointerup', end);
  // fallback for touch devices (if pointer not supported)
  el.addEventListener('touchstart', start, {passive:false});
  window.addEventListener('touchmove', move, {passive:false});
  window.addEventListener('touchend', end);
  // double click to remove
  el.addEventListener('dblclick', ()=>{
    ornaments = ornaments.filter(x=>x.id !== model.id);
    renderOrnaments();
    saveLocalDebounced();
  });
}

/* -------- Local storage -------- */
function saveLocal(){
  try {
    localStorage.setItem(STAGE_KEY, JSON.stringify(ornaments));
    console.log('Saved locally', ornaments.length);
  } catch(e) { console.warn('Local save failed', e); }
}
let saveTimer = null;
function saveLocalDebounced(){ clearTimeout(saveTimer); saveTimer = setTimeout(saveLocal, 350); }

function loadLocal(){
  try{
    const raw = localStorage.getItem(STAGE_KEY);
    if (!raw) return;
    ornaments = JSON.parse(raw) || [];
    renderOrnaments();
  }catch(e){ console.warn('Local load failed', e); }
}

saveLocalBtn.addEventListener('click', ()=>{ saveLocal(); alert('Saved locally.'); });
loadLocalBtn.addEventListener('click', ()=>{ loadLocal(); alert('Loaded local decorations.'); });
clearBtn.addEventListener('click', ()=>{ if(confirm('Clear all ornaments?')){ ornaments=[]; renderOrnaments(); saveLocal(); } });

/* -------- Export / Import -------- */
exportBtn.addEventListener('click', ()=>{
  const data = JSON.stringify(ornaments, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='tree-decoration.json'; a.click();
  URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  const text = await f.text();
  try {
    const parsed = JSON.parse(text);
    if (!Array.isArray(parsed)) throw 'Invalid file format';
    ornaments = parsed;
    renderOrnaments();
    saveLocal();
    alert('Imported decorations.');
  } catch(err){ alert('Import failed: ' + err); }
});

/* -------- CloudKit (iCloud) ‚Äî OPTIONAL --------
   To enable:
   1) Create CloudKit container in Apple Developer / CloudKit Dashboard.
   2) Configure a "Web Services" key and allow your website origin in CloudKit dashboard.
   3) Add the CloudKit JS <script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
   4) Fill CONTAINER_ID and API_TOKEN below and uncomment the saveToCloud/loadFromCloud usage.
   NOTE: CloudKit requires HTTPS and users sign in with their Apple ID.
---------------------------------------------- */

const CLOUD_CONFIG = {
  ENABLED: false, // set to true after you follow setup steps
  CONTAINER: 'iCloud.com.example.container', // <-- replace with your container id
  API_TOKEN: 'PUBLIC_WEB_KEY',              // <-- replace with your Web Services key
  RECORD_TYPE: 'TreeDecoration',            // can be custom
  RECORD_ID: 'sharedTree'                   // single record id to hold the data
};

// Example skeleton functions using CloudKit JS (not active unless you enable above).
async function saveToCloudkit(){
  if (!CLOUD_CONFIG.ENABLED) { alert('Cloud disabled ‚Äî configure CloudKit first.'); return; }
  if (!window.CloudKit) { alert('CloudKit JS not loaded.'); return; }

  // Initialize CloudKit (example) ‚Äî you must host over HTTPS and set correct container/origin
  CloudKit.configure({
    services: [{
      apiToken: CLOUD_CONFIG.API_TOKEN,
      environment: 'production'
    }],
    containers: [{
      containerIdentifier: CLOUD_CONFIG.CONTAINER,
      apiTokenAuth: {
        apiToken: CLOUD_CONFIG.API_TOKEN,
        persist: true
      }
    }]
  });

  const container = CloudKit.getDefaultContainer();
  const database = container.publicCloudDatabase;

  const payload = { ornaments, savedAt: new Date().toISOString() };
  // Save as a single record
  try {
    // fetch existing or create new
    const rec = { recordType: CLOUD_CONFIG.RECORD_TYPE, recordName: CLOUD_CONFIG.RECORD_ID, fields: { data: { value: JSON.stringify(payload) } } };
    const res = await database.saveRecords({ records: [ rec ] });
    console.log('Cloud save', res);
    alert('Saved to iCloud (CloudKit).');
  } catch (err) {
    console.error(err); alert('Cloud save failed: ' + err);
  }
}

async function loadFromCloudkit(){
  if (!CLOUD_CONFIG.ENABLED) { alert('Cloud disabled ‚Äî configure CloudKit first.'); return; }
  if (!window.CloudKit) { alert('CloudKit JS not loaded.'); return; }

  CloudKit.configure({
    services: [{ apiToken: CLOUD_CONFIG.API_TOKEN, environment:'production' }],
    containers: [{ containerIdentifier: CLOUD_CONFIG.CONTAINER }]
  });
  const container = CloudKit.getDefaultContainer();
  const database = container.publicCloudDatabase;

  try {
    const res = await database.fetchRecords({ recordName: CLOUD_CONFIG.RECORD_ID });
    if (res && res.records && res.records.length) {
      const v = res.records[0].fields.data.value;
      const payload = JSON.parse(v);
      ornaments = payload.ornaments || [];
      renderOrnaments();
      saveLocal(); // store locally too
      alert('Loaded from iCloud.');
    } else {
      alert('No cloud record found.');
    }
  } catch(err) { console.error(err); alert('Cloud load failed: ' + err); }
}

// hook cloud buttons
saveCloudBtn.addEventListener('click', saveToCloudkit);
loadCloudBtn.addEventListener('click', loadFromCloudkit);

/* ---------- initialize ---------- */
loadLocal(); // restore local on start
renderOrnaments();
</script>
</body>
</html>
